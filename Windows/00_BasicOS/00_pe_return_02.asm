; 00_return_03.asm
;   - See "Peering Inside the PE: A Tour of the Win32 Portable Executable File Format"
;     https://msdn.microsoft.com/en-us/library/ms809762.aspx
;   1. Mark labels and sizes
;   2. Print to validate everything seems correct
;   3. Validate still works (i.e. nothing changed)
;      fasm 01_return_01.asm
;      ./01_return_01.asm
;      echo $?

format binary as "exe" 
org 0 
use64 

macro print_value_x32 description, value
{
  bits = 32
  display description
  display '0x'
  repeat bits/4
    d = '0' + value shr (bits-%*4) and 0Fh
    if d > '9'
      d = d + 'A'-'9'-1
    end if
    display d
  end repeat
  display $a
}

IMAGE_DOS_HEADER:

  db 0x4d, 0x5a             ; u16 e_magic
  db 0x80, 0x00             ; u16 e_cblp
  db 0x01, 0x00             ; u16 e_cp
  db 0x00, 0x00             ; u16 e_crlc
  db 0x04, 0x00             ; u16 e_cparhdr
  db 0x10, 0x00             ; u16 e_ss
  db 0xff, 0xff             ; u16 e_maxalloc
  db 0x00, 0x00             ; u16 e_minalloc
  db 0x40, 0x01             ; u16 e_sp 
  db 0x00, 0x00             ; u16 e_csum              
  db 0x00, 0x00             ; u16 e_ip  
  db 0x00, 0x00             ; u16 e_cs   
  db 0x40, 0x00             ; u16 e_lfarlc
  db 0x00, 0x00             ; u16 e_ovno              
  db 0x00, 0x00             ; u16 e_res[0]
  db 0x00, 0x00             ; u16 e_res[1]            
  db 0x00, 0x00             ; u16 e_res[2]
  db 0x00, 0x00             ; u16 e_res[3]            
  db 0x00, 0x00             ; u16 e_oemid 
  db 0x00, 0x00             ; u16 e_oeminfo
  db 0x00, 0x00             ; u16 e_res2[0]
  db 0x00, 0x00             ; u16 e_res2[1]
  db 0x00, 0x00             ; u16 e_res2[2]
  db 0x00, 0x00             ; u16 e_res2[3]           
  db 0x00, 0x00             ; u16 e_res2[4]
  db 0x00, 0x00             ; u16 e_res2[5]           
  db 0x00, 0x00             ; u16 e_res2[6]
  db 0x00, 0x00             ; u16 e_res2[7]          
  db 0x00, 0x00             ; u16 e_res2[8]
  db 0x00, 0x00             ; u16 e_res2[9]
  db 0x80, 0x00, 0x00, 0x00 ; u32 e_lfanew  

IMAGE_DOS_HEADER_END:
IMAGE_DOS_HEADER_SIZE = IMAGE_DOS_HEADER_END - IMAGE_DOS_HEADER

print_value_x32 "IMAGE_DOS_HEADER_SIZE             = ", IMAGE_DOS_HEADER_SIZE

IMAGE_DOS_PROGRAM:

  db 0x0e, 0x1f, 0xba, 0x0e, 0x00, 0xb4, 0x09, 0xcd 
  db 0x21, 0xb8, 0x01, 0x4c, 0xcd, 0x21, 0x54, 0x68
  db 0x69, 0x73, 0x20, 0x70, 0x72, 0x6f, 0x67, 0x72 
  db 0x61, 0x6d, 0x20, 0x63, 0x61, 0x6e, 0x6e, 0x6f 
  db 0x74, 0x20, 0x62, 0x65, 0x20, 0x72, 0x75, 0x6e 
  db 0x20, 0x69, 0x6e, 0x20, 0x44, 0x4f, 0x53, 0x20 
  db 0x6d, 0x6f, 0x64, 0x65, 0x2e, 0x0d, 0x0a, 0x24
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 

IMAGE_DOS_PROGRAM_END:
IMAGE_DOS_PROGRAM_SIZE = IMAGE_DOS_PROGRAM_END - IMAGE_DOS_PROGRAM

print_value_x32 "IMAGE_DOS_PROGRAM_SIZE            = ", IMAGE_DOS_PROGRAM_SIZE

IMAGE_NT_HEADERS: 
print_value_x32 "IMAGE_NT_HEADERS                  = ", IMAGE_NT_HEADERS

  db 0x50, 0x45, 0x00, 0x00 ; u32 Signature 

IMAGE_FILE_HEADER:
print_value_x32 "IMAGE_FILE_HEADER                 = ", IMAGE_FILE_HEADER

  db 0x64, 0x86             ; u16 Machine
  db 0x02, 0x00             ; u16 NumberOfSections
  db 0xd2, 0xc5, 0x9b, 0x58 ; u32 TimeDateStamp
  db 0x00, 0x00, 0x00, 0x00 ; u32 PointerToSymbolTable
  db 0x00, 0x00, 0x00, 0x00 ; u32 NumberOfSymbols
  db 0xf0, 0x00             ; u16 SizeOfOptionalHeader
  db 0x2f, 0x00             ; u16 Characteristics

IMAGE_FILE_HEADER_END:
IMAGE_FILE_HEADER_SIZE = IMAGE_FILE_HEADER_END-IMAGE_FILE_HEADER
print_value_x32 "IMAGE_FILE_HEADER_SIZE            = ", IMAGE_FILE_HEADER_SIZE

IMAGE_OPTIONAL_HEADER:
print_value_x32 "IMAGE_OPTIONAL_HEADER             = ", IMAGE_OPTIONAL_HEADER

  db 0x0b, 0x02                                     ; u16 Magic
  db 0x01                                           ; u8  MajorLinkerVersion
  db 0x47                                           ; u8  MinorLinkerVersion
  db 0x00, 0x02, 0x00, 0x00                         ; u32 SizeOfCode
  db 0x00, 0x02, 0x00, 0x00                         ; u32 SizeofInitializedData
  db 0x00, 0x00, 0x00, 0x00                         ; u32 SizeOfUninitializedData
  db 0x00, 0x10, 0x00, 0x00                         ; u32 AddressOfEntryPoint 
  db 0x00, 0x10, 0x00, 0x00                         ; u32 BaseOfCode 
  db 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00 ; u64 ImageBase
  db 0x00, 0x10, 0x00, 0x00                         ; u32 SectionAlignment
  db 0x00, 0x02, 0x00, 0x00                         ; u32 FileAlignment
  db 0x01, 0x00                                     ; u16 MajorOperatingSystemVersion
  db 0x00, 0x00                                     ; u16 MinorOperatingSystemVersion
  db 0x00, 0x00                                     ; u16 MajorImageVersion
  db 0x00, 0x00                                     ; u16 MinorImageVersion
  db 0x05, 0x00                                     ; u16 MajorSubsystemVersion
  db 0x00, 0x00                                     ; u16 MinorSubsystemVersion
  db 0x00, 0x00, 0x00, 0x00                         ; u32 Win32VersionValue
  db 0x00, 0x30, 0x00, 0x00                         ; u32 SizeOfImage
  db 0x00, 0x02, 0x00, 0x00                         ; u32 SizeOfHeaders
  db 0xdf, 0xeb, 0x00, 0x00                         ; u32 Checksum
  db 0x03, 0x00                                     ; u16 Subsystem
  db 0x00, 0x00                                     ; u16 DllCharacteristics
  db 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ; u64 SizeOfStackReserve
  db 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ; u64 SizeOfStackCommit
  db 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00 ; u64 SizeOfHeapReserve
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ; u64 SizeOfHeapCommit
  db 0x00, 0x00, 0x00, 0x00                         ; u32 LoaderFlags
  db 0x10, 0x00, 0x00, 0x00                         ; u32 NumberOfRvaAndSizes

IMAGE_DATA_DIRECTORIES:

IMAGE_DIRECTORY_ENTRY_EXPORT:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_IMPORT:

  db 0x00, 0x20, 0x00, 0x00 ; u32 VirtualAddress
  db 0x68, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_RESOURCE:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_EXCEPTION:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_SECURITY:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_BASERELOC:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_DEBUG:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_COPYRIGHT:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_GLOBALPTR:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_TLS:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_IAT:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_DIRECTORY_ENTRY_RESERVED:

  db 0x00, 0x00, 0x00, 0x00 ; u32 VirtualAddress
  db 0x00, 0x00, 0x00, 0x00 ; u32 Size

IMAGE_OPTIONAL_HEADER_END:
IMAGE_OPTIONAL_HEADER_SIZE = IMAGE_OPTIONAL_HEADER_END-IMAGE_OPTIONAL_HEADER
print_value_x32 "IMAGE_OPTIONAL_HEADER_SIZE        = ", IMAGE_OPTIONAL_HEADER_SIZE

SECTION_TABLE:
print_value_x32 "SECTION_TABLE                     = ", SECTION_TABLE

SECTION_TABLE_ENTRY_CODE:

  db 0x2e, 0x63, 0x6f, 0x64, 0x65, 0x00, 0x00, 0x00 ; char Name[8]
  db 0x15, 0x00, 0x00, 0x00                         ; u32  VirtualSize
  db 0x00, 0x10, 0x00, 0x00                         ; u32  VirtualAddress
  db 0x00, 0x02, 0x00, 0x00                         ; u32  SizeOfRawData
  db 0x00, 0x02, 0x00, 0x00                         ; u32  PointerToRawData
  db 0x00, 0x00, 0x00, 0x00                         ; u32  PointerToRelocations
  db 0x00, 0x00, 0x00, 0x00                         ; u32  PointerToLinenumbers
  db 0x00, 0x00                                     ; u32  NumberOfRelocations
  db 0x00, 0x00                                     ; u32  NumberOfLineNumbers
  db 0x20, 0x00, 0x00, 0x60                         ; u32  Characteristics

SECTION_TABLE_ENTRY_IDATA:

  db 0x2e, 0x69, 0x64, 0x61, 0x74, 0x61, 0x00, 0x00 ; char Name[8]
  db 0x68, 0x00, 0x00, 0x00                         ; u32  VirtualSize
  db 0x00, 0x20, 0x00, 0x00                         ; u32  VirtualAddress
  db 0x00, 0x02, 0x00, 0x00                         ; u32  SizeOfRawData
  db 0x00, 0x04, 0x00, 0x00                         ; u32  PointerToRawData
  db 0x00, 0x00, 0x00, 0x00                         ; u32  PointerToRelocations
  db 0x00, 0x00, 0x00, 0x00                         ; u32  PointerToLinenumbers
  db 0x00, 0x00                                     ; u32  NumberOfRelocations
  db 0x00, 0x00                                     ; u32  NumberOfLineNumbers
  db 0x40, 0x00, 0x00, 0xc0                         ; u32  Characteristics

SECTION_TABLE_END:
SECTION_TABLE_SIZE = SECTION_TABLE_END-SECTION_TABLE
print_value_x32 "SECTION_TABLE_SIZE                = ", SECTION_TABLE_SIZE

IMAGE_NT_HEADERS_END:

IMAGE_NT_HEADERS_PADDING:

  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00

IMAGE_NT_HEADERS_PADDING_END:
IMAGE_NT_HEADERS_ROUND_SIZE = IMAGE_NT_HEADERS_PADDING_END-IMAGE_NT_HEADERS

print_value_x32 "IMAGE_NT_HEADERS_ROUND_SIZE       = ", IMAGE_NT_HEADERS_ROUND_SIZE

CODE:
CODE.RVA = 0x1000
print_value_x32 "CODE                              = ", CODE
print_value_x32 "CODE RVA                          = ", CODE.RVA

  db 0xb8
  db 0x2a
  db 0x00
  db 0x00
  db 0x00
  db 0x48
  db 0x83
  db 0xec
  db 0x20
  db 0x89
  db 0xc1
  db 0xff
  db 0x15
  db 0x37
  db 0x10
  db 0x00
  db 0x00
  db 0x48
  db 0x83
  db 0xc4
  db 0x20

CODE_END:
CODE_SIZE = CODE_END-CODE

print_value_x32 "CODE_SIZE                         = ", CODE_SIZE

CODE_PADDING:

  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00

IDATA:
IDATA.RVA = 0x2000
print_value_x32 "IDATA                             = ", IDATA
print_value_x32 "IDATA RVA                         = ", IDATA.RVA

IMAGE_IMPORT_DIRECTORY:
print_value_x32 "IMAGE_IMPORT_DIRECTORY            = ", IMAGE_IMPORT_DIRECTORY

IMAGE_IMPORT_KERNEL32:
print_value_x32 "IMAGE_IMPORT_KERNEL32             = ", IMAGE_IMPORT_KERNEL32

  db 0x38, 0x20, 0x00, 0x00 ; u32 rvaImportLookupTable
  db 0x00, 0x00, 0x00, 0x00 ; u32 TimeDateStamp
  db 0x00, 0x00, 0x00, 0x00 ; u32 ForwarderChain
  db 0x28, 0x20, 0x00, 0x00 ; u32 rvaModuleName
  db 0x48, 0x20, 0x00, 0x00 ; u32 rvaImportAddressTable

IMAGE_IMPORT_END:
print_value_x32 "IMAGE_IMPORT_END                  = ", IMAGE_IMPORT_END

  db 0x00, 0x00, 0x00, 0x00 ; u32 rvaImportLookupTable
  db 0x00, 0x00, 0x00, 0x00 ; u32 TimeDateStamp
  db 0x00, 0x00, 0x00, 0x00 ; u32 ForwarderChain
  db 0x00, 0x00, 0x00, 0x00 ; u32 rvaModuleName
  db 0x00, 0x00, 0x00, 0x00 ; u32 rvaImportAddressTable

IMAGE_IMPORT_DIRECTORY_END:
IMAGE_IMPORT_DIRECTORY_SIZE = IMAGE_IMPORT_DIRECTORY_END-IMAGE_IMPORT_DIRECTORY

print_value_x32 "IMAGE_IMPORT_DIRECTORY_SIZE       = ", IMAGE_IMPORT_DIRECTORY_SIZE

KERNEL32_MODULE_NAME:
KERNEL32_MODULE_NAME.RVA =  (KERNEL32_MODULE_NAME-IDATA)+IDATA.RVA
print_value_x32 "KERNEL32_MODULE_NAME              = ", KERNEL32_MODULE_NAME
print_value_x32 "KERNEL32_MODULE_NAME RVA          = ", KERNEL32_MODULE_NAME.RVA

  db 0x6b, 0x65, 0x72, 0x6e, 0x65, 0x6c, 0x33, 0x32, 0x2e, 0x64, 0x6c, 0x6c, 0x00

KERNEL32_MODULE_NAME_PADDING:

  db 0x00, 0x00, 0x00

KERNEL32_IMPORT_LOOKUP_TABLE:
KERNEL32_IMPORT_LOOKUP_TABLE.RVA = (KERNEL32_IMPORT_LOOKUP_TABLE-IDATA)+IDATA.RVA
print_value_x32 "KERNEL32_IMPORT_LOOKUP_TABLE      = ", KERNEL32_IMPORT_LOOKUP_TABLE
print_value_x32 "KERNEL32_IMPORT_LOOKUP_TABLE RVA  = ", KERNEL32_IMPORT_LOOKUP_TABLE.RVA

  db 0x58, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00

KERNEL32_IMPORT_ADDRESS_TABLE:
KERNEL32_IMPORT_ADDRESS_TABLE.RVA = (KERNEL32_IMPORT_ADDRESS_TABLE-IDATA)+IDATA.RVA
print_value_x32 "KERNEL32_IMPORT_ADDRESS_TABLE     = ", KERNEL32_IMPORT_ADDRESS_TABLE
print_value_x32 "KERNEL32_IMPORT_ADDRESS_TABLE RVA = ", KERNEL32_IMPORT_ADDRESS_TABLE.RVA

  db 0x58, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00

IMPORT_NAMES:

  .ExitProcess:
  .ExitProcess.RVA = (IMPORT_NAMES.ExitProcess-IDATA)+IDATA.RVA

print_value_x32 "IMPORT_NAMES.ExitProcess          = ", IMPORT_NAMES.ExitProcess
print_value_x32 "IMPORT_NAMES.ExitProcess RVA      = ", IMPORT_NAMES.ExitProcess.RVA

    db 0x00, 0x00                                                              ; u16     Hint
    db 0x45, 0x78, 0x69, 0x74, 0x50, 0x72, 0x6f, 0x63, 0x65, 0x73, 0x73, 0x00  ; cstring Name

IMPORT_NAMES_END:

IMPORT_NAMES_PADDING:

  db 0x00, 0x00

IDATA_END:
IDATA_SIZE = IDATA_END-IDATA
print_value_x32 "IDATA_SIZE                        = ", IDATA_SIZE

IDATA_PADDING:

  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00

FILE_END:
FILE_SIZE = FILE_END-IMAGE_DOS_HEADER
print_value_x32 "FILE_SIZE                         = ", FILE_SIZE
